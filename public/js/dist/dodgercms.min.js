/*! drafty 0.0.2 2016-08-24 */
var dodgercms=dodgercms||{};dodgercms.auth=function(){"use strict";function login(params,callback){}function logout(){}function redirect(uri){}return{login:login,logout:logout,redirect:redirect}}();var dodgercms=dodgercms||{};dodgercms.entry=function(){"use strict";function remove(key,dataBucket,siteBucket,callback){dodgercms.s3.deleteObjects(key,dataBucket,function(err,data){err?callback(err):dodgercms.s3.deleteObjects(key,siteBucket,function(err,data){err?callback(err):callback(null,data)})})}function rename(source,target,dataBucket,siteBucket,callback){dodgercms.s3.renameObjects(source,target,dataBucket,function(err,data){err?callback(err):dodgercms.s3.renameObjects(source,target,siteBucket,function(err,data){err?callback(err):remove(source,dataBucket,siteBucket,callback)})})}function upsert(key,metadata,content,bucket,endpoint,callback){async.waterfall([function(waterfallCb){var options={renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!1,highlight:function(code){return hljs.highlightAuto(code).value}};marked(content,options,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})},function(body,waterfallCb){var entry,modified=new Date,context={key:key,title:metadata.title,modified:modified.toLocaleString(),body:body,bucket:bucket,endpoint:endpoint,dataKey:DATA_KEY};entry="undefined"!=typeof metadata.template?dodgercms.templates[metadata.template.toString()]:dodgercms.templates[DEFAULT_TEMPLATES[0].id];var html="<html></html>";"function"==typeof entry&&(html=entry(context)),waterfallCb(null,html)},function(html,waterfallCb){var params={Bucket:bucket,Key:key,Body:html,ContentType:"text/html; charset=UTF-8",Expires:0,CacheControl:"public, max-age=0, no-cache",Metadata:metadata};metadata.visibility&&"visible"!=metadata.visibility?dodgercms.s3.deleteObjects(params.Key,params.Bucket,function(err,data){waterfallCb(err?err:null)}):dodgercms.s3.upload(params,function(err,data){waterfallCb(err?err:null)})}],function(err,result){err?callback(err):callback(null,result)})}function menu(bucket,endpoint,callback){async.waterfall([function(waterfallCb){dodgercms.s3.listObjects(null,bucket,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})},function(data,waterfallCb){for(var contents=data.Contents,i=contents.length-1;i>=0;i-=1)"."===contents[i].Key.substr(0,1)&&contents.splice(i,1);waterfallCb(null,contents)},function(data,waterfallCb){var keys=[];async.each(data,function(object,cb){dodgercms.s3.headObject(object.Key,bucket,function(err,objectData){err?cb(err):(objectData.Key=object.Key,keys.push(objectData),cb(null))})},function(err){err?waterfallCb(err):waterfallCb(null,keys)})},function(keys,waterfallCb){function buildFromSegments(scope,parentScope,keyParts,pathSegments,isFolder,keyLabel){var current=pathSegments.shift();keyParts.push(current);var label=current,found=findInScope(scope,current);if(found)!pathSegments.length&&isFolder&&keyLabel&&(found.label=keyLabel);else{var key=keyParts.join("/");pathSegments.length?key+="/":(isFolder&&(key+="/"),keyLabel&&(label=keyLabel)),found={key:key,part:current,index:!pathSegments.length&&"index"===current,link:isFolder?null:key,label:label,children:!1},parentScope&&"index"===current&&(parentScope.link=parentScope.key),scope.push(found)}pathSegments.length&&(found.children=found.children||[],buildFromSegments(found.children,found,keyParts,pathSegments,isFolder,keyLabel))}function findInScope(scope,find){for(var i=0;i<scope.length;i++)if(scope[i].part===find)return scope[i]}keys=_.sortBy(keys,function(item){return item.Metadata.title?item.Metadata.title.toString():item.Key.toString()});var tree=[];keys.forEach(function(object){var key=object.Key,isFolder="/"===key.substr(-1),label=isFolder?object.Metadata.label:object.Metadata.title,parts=object.Key.replace(/\/\s*$/,"").split("/");buildFromSegments(tree,null,[],parts,isFolder,label)}),waterfallCb(null,tree)},function(data,waterfallCb){data=_.sortBy(data,function(item){return item.label.toString()});var params={Bucket:bucket,Key:DATA_KEY,Body:JSON.stringify(data),ContentType:"application/json; charset=UTF-8",Expires:0,CacheControl:"public, max-age=0, no-cache"};dodgercms.s3.upload(params,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})}],function(err,result){err?callback(err):callback(null,result)})}var DATA_KEY=".dodgercms/data.json";return{upsert:upsert,remove:remove,rename:rename,menu:menu}}();var dodgercms=dodgercms||{};dodgercms.s3=function(){"use strict";function init(){return s3=new AWS.S3({sslEnabled:!0,DurationSeconds:129600,apiVersion:API_VERSION,maxRetries:1})}function getApiVersion(){return API_VERSION}function renameObject(source,target,bucket,callback){var params={Bucket:bucket,MetadataDirective:"COPY",CopySource:bucket+"/"+source,Key:target};s3.copyObject(params,function(err,data){err?callback(err):deleteObject(source,bucket,callback)})}function upload(params,callback){sessionStorage.s3data&&sessionStorage.removeItem("s3data"),sessionStorage.s3meta&&sessionStorage.removeItem("s3meta"),s3.upload(params,function(err,data){err?callback(err):callback(null,data)})}function getObject(key,bucket,callback){var params={Bucket:bucket,Key:key};if(sessionStorage.s3data){var data=JSON.parse(sessionStorage.s3data),item=_.findWhere(data.Contents,{Key:key});if(sessionStorage.getItem(item.ETag+"_"+key)){var localItem=JSON.parse(sessionStorage.getItem(item.ETag+"_"+key));return localItem.Body=JSON.parse(sessionStorage.getItem(item.ETag+"_"+key+"-Body")),void callback(null,localItem)}}s3.getObject(params,function(err,data){err?callback(err):(sessionStorage.setItem(data.ETag+"_"+key,JSON.stringify(data)),sessionStorage.setItem(data.ETag+"_"+key+"-Body",JSON.stringify(data.Body.toString())),callback(null,data))})}function headObject(key,bucket,callback){var params={Bucket:bucket,Key:key};s3.headObject(params,function(err,data){err?callback(err):callback(null,data)})}function putObject(key,bucket,callback){var params;2===arguments.length&&"object"==typeof key?(params=key,callback=bucket):params={Bucket:bucket,Key:key},s3.putObject(params,function(err,data){err?callback(err):callback(null,data)})}function deleteObject(key,bucket,callback){var params={Bucket:bucket,Key:key};s3.deleteObject(params,function(err,data){err&&"NoSuckKey"!==err.code?callback(err):callback(null,data)})}function copyObject(source,target,bucket,callback){var params={Bucket:bucket,MetadataDirective:"COPY",CopySource:bucket+"/"+source,Key:target};s3.copyObject(params,function(err,data){err?callback(err):callback(null,data)})}function renameObjects(source,target,bucket,callback){if("/"===source.substr(-1)){var parts=source.replace(/\/\s*$/,"").split("/");parts.splice(-1,1,target);var targetPrefix=parts.join("/")+"/";sessionStorage.s3data&&sessionStorage.removeItem("s3data"),sessionStorage.s3meta&&sessionStorage.removeItem("s3meta"),listObjects(source,bucket,function(err,data){if(err)callback(err);else{var contents=data.Contents;async.each(contents,function(object,cb){var key=targetPrefix+object.Key.substr(source.length);dodgercms.s3.copyObject(object.Key,key,bucket,cb)},function(err){callback(err?err:null)})}})}else dodgercms.s3.copyObject(source,target,bucket,callback)}function deleteObjects(key,bucket,callback){"/"===key.substr(-1)?listObjects(key,bucket,function(err,data){if(err)callback(err);else{var contents=data.Contents;async.each(contents,function(object,cb){dodgercms.s3.deleteObject(object.Key,bucket,cb)},function(err){callback(err?err:null)})}}):dodgercms.s3.deleteObject(key,bucket,callback)}function listObjects(prefix,bucket,callback){2===arguments.length&&(callback=bucket,bucket=prefix,prefix="");var params={Bucket:bucket,EncodingType:ENCODING_TYPE,MaxKeys:1e3,Prefix:prefix};s3.listObjects(params,function(err,data){err?callback(err):(sessionStorage.setItem("s3data",JSON.stringify(data)),callback(null,data))})}function headObjects(contents,bucket,callback){var keys=[];async.each(contents,function(object,cb){s3.headObject({Bucket:bucket,Key:object.Key},function(err,data){err?cb(err):(data.Key=object.Key,keys.push(data),cb(null))})},function(err){err?callback(err):(sessionStorage.setItem("s3meta",JSON.stringify(keys)),callback(null,keys))})}var ENCODING_TYPE="url",API_VERSION="2011-06-15",s3=null;return{init:init,getApiVersion:getApiVersion,getObject:getObject,upload:upload,headObject:headObject,putObject:putObject,copyObject:copyObject,deleteObject:deleteObject,deleteObjects:deleteObjects,renameObject:renameObject,renameObjects:renameObjects,listObjects:listObjects,headObjects:headObjects}}();var dodgercms=dodgercms||{};dodgercms.utils=function(){"use strict";function getFolders(objects){for(var folders=["/"],i=0;i<objects.length;i+=1)for(var key=objects[i].Key,parts=key.replace(/\/\s*$/,"").split("/"),j=0;j<parts.length;j+=1){var isFolder=!1;if((j===parts.length-1&&"/"===key.substr(-1)||j!==parts.length-1)&&(isFolder=!0),isFolder){var folder=parts.slice(0,j+1).join("/")+"/";$.inArray(folder,folders)<0&&folders.push(folder)}}return folders}function newFolder(key,dataBucket,siteBucket,callback){dodgercms.s3.putObject(key,dataBucket,function(err,data){err?callback(err):dodgercms.s3.putObject(key,siteBucket,function(err,data){err?callback(err):"undefined"!=typeof callback&&callback(null,key)})})}function isFolder(key){return"/"===key.substr(-1)}function getSlug(key){var parts=key.split("/");return parts.pop()}return{newFolder:newFolder,isFolder:isFolder,getSlug:getSlug,getFolders:getFolders}}();