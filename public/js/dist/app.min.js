/*! drafty 0.0.2 2016-08-24 */
var SITES=[{name:"Drafty Docs",markdown_bucket:"drafty-doc-markdown",assets_bucket:"drafty-doc-assets",site_bucket:"drafty-doc-site",aws_region:"us-east-1",datatypes:[],templates:[]}],DEFAULT_DATATYPES=[{id:"html",name:"HTML"},{id:"markdown",name:"Markdown"},{id:"multiples",name:"Multiples"}],DATATYPES=DEFAULT_DATATYPES,DEFAULT_TEMPLATES=[{id:"templates/entry.html",name:"Generic Page"}],TEMPLATES=DEFAULT_TEMPLATES,PARTIALS_PATH="public/js/data-types/partials/",DATA_BUCKET,ASSETS_BUCKET,SITE_BUCKET,AWS_REGION="us-east-1";if(1===SITES.length&&(DATA_BUCKET=SITES[0].markdown_bucket,ASSETS_BUCKET=SITES[0].assets_bucket,SITE_BUCKET=SITES[0].site_bucket,AWS_REGION=SITES[0].aws_region,SITES[0].datatypes))for(var i in SITES[0].datatypes)DATATYPES.push(SITES[0].datatypes[i]);var SITE_ENDPOINT="http://"+SITE_BUCKET+".s3-website-"+AWS_REGION+".amazonaws.com/",CONTENT_TYPE="text/plain; charset=UTF-8",S3_ENDPOINT="s3.amazonaws.com",POOL_ID="us-east-1_csyX70qkT",CLIENT_ID="1ldo9fqfs6e8lm4b6tls1s068p",ID_POOL_ID="us-east-1:9c524e6a-82f3-4c45-a430-44b15e9c5032",dodgercms=dodgercms||{};$(function(){"use strict";function initialize(){AWS.config.region=AWS_REGION;var creds={};creds["cognito-idp."+AWS_REGION+".amazonaws.com/"+POOL_ID]=sessionStorage.getItem("cognito-token"),AWS.config.update({credentials:new AWS.CognitoIdentityCredentials({IdentityPoolId:ID_POOL_ID,Logins:creds})}),Handlebars.registerHelper("selected",function(option,value){return option===value?' selected="selected"':""}),Handlebars.registerHelper("raw-helper",function(options){return options.fn()}),removeTinyMCE(),dodgercms.s3.init(),rebuildTree(),$("#new-entry-data-types").empty(),_.each(DATATYPES,function(element){$("#new-entry-data-types").append('<li><a data-value="'+element.id+'">'+element.name+"</a></li>")}),$("#nav .nav:hidden").fadeIn()}function errorHandler(err){"CredentialsError"==err.code&&$.blockUI({css:{border:"none","font-size":"90%",padding:"15px",backgroundColor:"rgba(0,0,0,0.5)","-webkit-border-radius":"10px","-moz-border-radius":"10px"},message:'<form id="application-login" autocomplete="off" class="well"><p>Your session expired. Please re-submit your login credentials.</p><fieldset><div class="input-group"><input name="user" placeholder="Username" class="form-control" /></div><div class="input-group"><input name="pw" type="password" placeholder="Password" class="form-control" /></div><div class="input-group"><button type="submit" class="btn btn-primary">Login</button></div></fieldset></form>'})}function rebuildTree(){$("#tree").jstree("destroy").empty(),buildTree()}function buildTree(){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){err?errorHandler(err):dodgercms.s3.headObjects(data.Contents,DATA_BUCKET,function(err,data){var $tree=$("#tree"),tree=[];tree.push({id:"s3--root",parent:"#",text:'<span class="bucket">'+DATA_BUCKET+"</span>",type:"folder",a_attr:{title:DATA_BUCKET},li_attr:{"data-key":"/"},state:{opened:!0}});for(var searchFn=function(e){return e.id===search},i=0;i<data.length;i+=1){var object=data[i],key=object.Key;if("/"===key.substr(-1)||object.ContentType===CONTENT_TYPE)for(var parts=key.replace(/\/\s*$/,"").split("/"),j=0;j<parts.length;j+=1){var isFolder=!1;(j===parts.length-1&&"/"===key.substr(-1)||j!==parts.length-1)&&(isFolder=!0);var search="s3-"+(j>0?parts.slice(0,j+1).join("-"):parts[j]);isFolder&&(search+="-folder");var result=$.grep(tree,searchFn);if(result.length)parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(result[0].li_attr["data-label"]=object.Metadata.label,result[0].a_attr.title=object.Metadata.label);else{var parent=j>0?"s3-"+parts.slice(0,j).join("-"):"s3--root";"s3--root"!==parent&&(parent+="-folder");var node={id:search,parent:parent,text:parts[j],type:isFolder?"folder":"file",a_attr:{},state:{opened:!0}};isFolder?(node.li_attr={"data-key":j>0?parts.slice(0,j+1).join("/")+"/":parts[j]+"/"},parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(node.li_attr["data-label"]=object.Metadata.label,node.a_attr.title=object.Metadata.label)):(parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.title&&(node.a_attr.title=object.Metadata.title),"index"===parts[j]&&(node.type="index"),node.li_attr={"data-key":key}),tree.push(node)}}}var onTreeChange=function(event,data){var action=data.action;switch(action){case"select_node":if("folder"!==data.node.type){var key=data.node.li_attr["data-key"];dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){err?errorHandler(err):(loadKeyContent(key,data),$("#main").data("key",key))})}}},customMenu=function(node){var newFolder=function(elem){for(var input="",key=node.li_attr["data-key"];!/^([a-zA-Z0-9-_]){1,32}$/.test(input);){if(input=window.prompt("Enter the name of the new folder."),null===input)return;input=input.toLowerCase()}if("folder"===node.type){var newKey="/"===key?input+"/":key+input+"/";dodgercms.utils.newFolder(newKey,DATA_BUCKET,SITE_BUCKET,function(err,data){addNode(newKey,key,input)})}},renameItem=function(elem){var msg,key=node.li_attr["data-key"],parts=key.replace(/\/\s*$/,"").split("/"),last=parts[parts.length-1],input=last;do{if(msg="folder"===node.type?"Enter the new name for folder: "+input:"Enter the new name for entry: "+input,input=window.prompt(msg,input),null===input)return;input=input.toLowerCase()}while(!/^([a-zA-Z0-9-_]){1,32}$/.test(input));if(input!==last){block();var target=input;"folder"!==node.type&&(parts.splice(-1,1,input),target=parts.join("/")),dodgercms.entry.rename(key,target,DATA_BUCKET,SITE_BUCKET,function(err,data){unblock(),err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){err?errorHandler(err):(rebuildTree(),$("#main").data("key",key))})})}},editLabel=function(elem){var input,msg,label=node.li_attr["data-label"],key=node.li_attr["data-key"];do if(msg=label?"Enter the name of the new label for the directory: "+key:"Enter the label (used for the frontend menu) for the directory: "+key,input=label?window.prompt(msg,label):window.prompt(msg),null===input)return;while(!/^([\w-_\.\s\(\)\/\\]){1,32}$/.test(input));if(input!==label){var params={Bucket:DATA_BUCKET,Key:key,Metadata:{label:input}};dodgercms.s3.putObject(params,function(err,data){err?errorHandler(err):(params.Bucket=SITE_BUCKET,dodgercms.s3.putObject(params,function(err,data){err&&errorHandler(err)}))})}},editItem=function(elem){var key=node.li_attr["data-key"];editEntry(key)},removeItem=function(elem){var key=node.li_attr["data-key"],input=window.confirm("Are you sure?");null!==input&&dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){clearEntry(key),$tree.jstree("delete_node","#"+node.id)})})},newItem=function(elem){var key=node.li_attr["data-key"];"folder"===node.type&&newEntry(key)},items={editLabel:{},newEntry:{label:"New Entry",action:newItem},editEntry:{label:"Edit",action:editItem},newFolder:{label:"New Folder",separator_after:!0,action:newFolder},renameItem:{label:"Rename",action:renameItem},removeItem:{label:"Delete",action:removeItem}};if("folder"===node.type){var label=node.li_attr["data-label"],labelText=label?"Edit Label":"Add Label";items.editLabel={label:labelText,separator_after:!0,action:editLabel},delete items.editEntry}else items.newEntry._disabled=!0,items.newFolder._disabled=!0,delete items.editLabel;return"s3--root"===node.id&&(items.removeItem._disabled=!0,items.renameItem._disabled=!0,items.editLabel._disabled=!0),items};$tree.on("changed.jstree",onTreeChange).jstree({core:{check_callback:!0,themes:{dots:!0,name:"proton",responsive:!1},animation:!1,data:tree},types:{"default":{icon:"fa"},file:{icon:"fa fa-file-text-o"},index:{icon:"fa fa-asterisk"},folder:{icon:"fa fa-folder-o",select_node:!1}},plugins:["unique","contextmenu","sort","ui","types"],contextmenu:{items:customMenu,select_node:!1},sort:function(a,b){var nodeA=this.get_node(a),nodeB=this.get_node(b);return nodeA.type===nodeB.type?this.get_text(a)>this.get_text(b)?1:-1:"index"===nodeA.type?-1:"index"===nodeB.type?1:"file"===nodeA.type?1:-1}})})})}function doesTreeNodeExist(id){return!!$("#tree").jstree("get_node",id)}function addNode(key,parent,text,title){var folder=dodgercms.utils.isFolder(key),id=getTreeNodeId(key);parent=getTreeNodeId(parent);var node={id:id,parent:parent,text:text,type:folder?"folder":"file",li_attr:{"data-key":key},state:{opened:!0}};return"index"===text&&(node.type=text),title&&(node.a_attr={title:title}),doesTreeNodeExist(id)||$("#tree").jstree("create_node","#"+parent,node),node}function block(){$.blockUI({css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"},overlayCSS:{backgroundColor:"#000",opacity:0,cursor:"wait"}})}function unblock(){$.unblockUI()}function processFormFields($content){var content="";return $content.find("input, select, textarea").each(function(){var before=$(this).data("before")?$(this).data("before"):"",after=$(this).data("after")?$(this).data("after"):"";if(!(($(this).is(":radio")||$(this).is(":checkbox"))&&$(this).is(":not(:checked)")||$(this).is('[type="file"]')||""===$(this).val())){var cssclass="";if($(this).data("class")&&(cssclass=' class="'+$(this).data("class")+'"'),"markdown"!=$(this).attr("id")&&(content+='<div id="'+$(this).attr("id")+'"'+cssclass+">"),""!==before&&(content+='<span class="before">'+before+"</span>"),$(this).data("wrapwith")){var nodes=$(this).data("wrapwith").split("><");content+=2==nodes.length?nodes[0]+">"+$.trim($(this).val())+"<"+nodes[1]:$.trim($(this).val())}else content+=$.trim($(this).val());""!==after&&(content+='<span class="after">'+after+"</span>"),"markdown"!=$(this).attr("id")&&(content+="</div>")}}),content}function getMetadata(){var metadata={};return $("#document-editor .metadata").each(function(){metadata[$(this).attr("id")]=$(this).val()}),metadata}function save(event){event.preventDefault();var $title=$("#title"),$folder=$("#entry-form-folder"),$slug=$("#entry-form-slug"),$content=$("#content-body-container"),title=$.trim($title.val()),folder=$("option:selected",$folder).data("folder"),slug=$.trim($slug.val()).toLowerCase(),content=processFormFields($content);if(!title.length||title.length>64)return alert("The title needs to be between 1 and 64 characters."),!1;if(!/^([a-zA-Z0-9-_]){1,32}$/.test(slug))return alert("The url slug must be at most 32 characters, and can only contain letters, numbers, dashes, underscores."),!1;block();var metadata=getMetadata(),callback=function(key,folder,slug){$("#main").data("key",key),addNode(key,folder,slug,title),$slug.data("entry-form-slug",slug),$slug.val(slug),$folder.data("value",folder);var metadata=getMetadata();dodgercms.entry.upsert(key,metadata,content,SITE_BUCKET,SITE_ENDPOINT,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){unblock()})})},key="/"!==folder?folder+slug:slug,$folderData=$folder.data("value"),$slugData=$slug.data("entry-form-slug");if($slugData&&$folderData&&($folderData!==folder||$slugData!==slug)){var oldKey="/"!==$folderData?$folderData+$slugData:$slugData;dodgercms.entry.rename(oldKey,key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):($("#tree").jstree("delete_node","#"+getTreeNodeId(oldKey)),callback(key,folder,slug))})}else{var params={Bucket:DATA_BUCKET,Key:key,Body:content,ContentEncoding:"utf-8",ContentType:CONTENT_TYPE,Expires:0,CacheControl:"public, max-age=0, no-cache",Metadata:metadata};dodgercms.s3.putObject(params,function(err,data){callback(key,folder,slug)})}return!0}function editEntry(key){dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){var body="";sessionStorage.getItem(data.ETag+"_"+key+"-Body")?body=JSON.parse(sessionStorage.getItem(data.ETag+"_"+key+"-Body")):null!==data.Body&&(body=data.Body.toString());var source=$("#edit-entry-template").html(),template=Handlebars.compile(source),modified=new Date(data.LastModified);dodgercms.s3.listObjects(DATA_BUCKET,function(err,list){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(list.Contents),slug=dodgercms.utils.getSlug(key),selectedFolder=key.indexOf("/")>-1?key.substr(0,key.lastIndexOf("/")+1):"/",context={title:data.Metadata.title,modified:modified.toLocaleString(),key:key,folders:folders,selectedFolder:selectedFolder,slug:slug,content:body,siteEndpoint:SITE_ENDPOINT,whichPartial:function(){return"data-type-is-"+data.Metadata.datatype}},html=template(context);$("#main").html(html),addTinyMCE(),addDataTypeSelector(data.Metadata.datatype),addPageTemplateSelector(null),setVisibilitySelect(data.Metadata.visibility),addBeforeAfterText(),"markdown"!==data.Metadata.datatype&&addAttachmentInputs(body),$("#datatype").val(data.Metadata.datatype),$("#template").val(data.Metadata.template),$("#entry-form select").each(function(){$(this).data("value")&&$(this).val($(this).data("value"))}),$("#delete-entry").hide(),$(window).scrollTop(0)}})})}function quickPublishEntry(item,callback){var key=item.Key;dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){dodgercms.s3.listObjects(DATA_BUCKET,function(err,list){if(err)errorHandler(err);else{var body="";body=sessionStorage.getItem(data.ETag+"_"+key+"-Body")?JSON.parse(sessionStorage.getItem(data.ETag+"_"+key+"-Body")):data.Body.toString();var metadata=data.Metadata;dodgercms.entry.upsert(key,metadata,body,SITE_BUCKET,SITE_ENDPOINT,function(err,data){err?(callback(err),errorHandler(err)):callback(null)})}})})}function clearEntry(key){key===$("#main").data("key")&&$("#main").empty().data("key",null)}function getTreeNodeId(key){if("/"===key)return"s3--root";var id,parts=key.replace(/\/\s*$/,"").split("/"),prefix="s3-",folderSuffix="-folder";return id=dodgercms.utils.isFolder(key)?prefix+parts.join("-")+folderSuffix:prefix+parts.join("-")}function newEntry(folder,datatype){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(data.Contents),context={folders:folders,selectedFolder:folder?folder:null,whichPartial:function(){return"data-type-is-"+(datatype?datatype:"html")}},source=$("#edit-entry-template").html(),template=Handlebars.compile(source),html=template(context);$("#main").html(html),addTinyMCE(),addDataTypeSelector(datatype),addPageTemplateSelector(null)}})}function loadKeyContent(key,content){removeTinyMCE();var body="";sessionStorage.getItem(content.ETag+"_"+key+"-Body")?body=JSON.parse(sessionStorage.getItem(content.ETag+"_"+key+"-Body")):null!==content.Body&&(body=content.Body.toString());var source=$("#entry-template").html(),template=Handlebars.compile(source),modified=new Date(content.LastModified),context={title:content.Metadata.title,modified:modified.toLocaleString(),link:SITE_ENDPOINT+key,key:key,content:marked(body,markedOptions)},html=template(context);$("#main").html(html).data("key",key),$("#main .content-body pre code").each(function(i,block){hljs.highlightBlock(block)})}function removeTinyMCE(){$(".wysiwyg").each(function(){tinymce.execCommand("mceRemoveEditor",!0,$(this).attr("id"))})}function addTinyMCE(){tinymce.init({selector:".wysiwyg",height:300,plugins:"code table",removed_menuitems:"newdocument"})}function addBeforeAfterText(){$("#entry-form").find("input,select,textarea").each(function(){$(this).data("before")&&$(this).before('<span class="recede">'+$(this).data("before")+" </span>"),$(this).data("after")&&$(this).after('<span class="recede">'+$(this).data("after")+" </span>")})}function addDataTypeSelector(datatype){_.each(DATATYPES,function(element){$("#datatype").append('<option value="'+element.id+'">'+element.name+"</option>")}),$("#datatype").off("change"),$("#datatype").on("change",function(event){save(event)&&setTimeout(function(){$("#close-entry").trigger("click")},500)}),$("#datatype").val(datatype)}function addPageTemplateSelector(template){template=template||"entry.html",_.each(TEMPLATES,function(t){$("#template").append('<option value="'+t.id+'">'+t.name+"</option>")}),$("#template").off("change"),$("#template").on("change",function(){save(event)&&setTimeout(function(){$("#close-entry").trigger("click")},500)}),$("#template").val(template)}function setVisibilitySelect(val){$("#visibility").val(val)}function addAttachmentInputs(body){$(body).find('a[data-type="attachment"]').each(function(){var filename=$(this).data("key");$("#"+$(this).data("input")).after('<div><input id="attachment-'+filename.replace(/\s|\\|\/|\(|\)/g,"-")+'" type="hidden" value="'+filename+"\" data-wrapwith=\"<a data-type='attachment' data-key='"+filename+"' href='"+$(this).attr("href")+"' data-input='"+$(this).data("input")+'\'></a>" /><i class="fa fa-paperclip"></i> '+filename+'<button class="button-xsmall pure-button remove-upload" data-key="'+filename+'"><i class="fa fa-times"></i></button></div>')})}function setEvents(){$("body").delegate("#new-entry-data-types a","click",function(event){event.preventDefault(),newEntry(null,$(this).data("value")),$("#new-entry-data-types").fadeOut()}),$(".publish-menu-link").click(function(){dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){err?errorHandler(err):rebuildTree()})}),$(".publish-all-link").click(function(event){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){async.each(data.Contents,quickPublishEntry,function(err){err?alert("Error: "+err):alert("Publish operation is complete.")})})}),$("body").delegate(".add-multiple","click",function(event){event.preventDefault();var target=$(this).data("target"),n=$(this).prevAll().filter(function(){return 0===$(this).children("input").attr("id").indexOf(target)}).length,row=$(this).prev().clone();row.children("input").attr("id",target+"_"+n),row.children("input").val(""),$(this).before(row)}),$("body").delegate(".remove-multiple","click",function(event){event.preventDefault(),$(this).parent().remove()}),$("body").delegate(".remove-upload","click",function(event){event.preventDefault();var $self=$(this);dodgercms.s3.deleteObject($self.data("key"),ASSETS_BUCKET,function(){$self.parent().remove()})}),$(document).on("click","#delete-entry",function(event){var key=$(this).data("key");"undefined"!=typeof key&&window.confirm("Are you sure?")&&dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){$("#tree").jstree("delete_node","#"+getTreeNodeId(key)),clearEntry(key)})})}),$(document).on("click","#close-entry",function(event){removeTinyMCE();var key=$("#main").data("key");key&&"/"!==key?dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){err?errorHandler(err):(loadKeyContent(key,data),$("#delete-entry").show())}):clearEntry(key)}),$(document).on("submit","#entry-form",save),$(document).on("click","#edit-entry",function(event){event.preventDefault();var key=$(this).data("key");"undefined"!=typeof key&&editEntry(key)}),$(document).on("change",".file-upload",function(event){var file=event.currentTarget.files[0],$input=$(event.currentTarget),$content=$("#content-body-container");if(!($content.length<=0)&&$content.is(":visible")){var filename="",types=["image/png","image/jpg","image/jpeg","image/gif"];filename=types.indexOf(file.type)!==-1?"images/"+Date.now()+"_"+file.name.replace(/\s|\\|\/|\(|\)/g,"-"):"files/"+Date.now()+"_"+file.name.replace(/\s|\\|\/|\(|\)/g,"-");var link="http://"+ASSETS_BUCKET+"."+S3_ENDPOINT+"/"+filename,params={Bucket:ASSETS_BUCKET,Key:filename,ContentType:file.type,Body:file};dodgercms.s3.upload(params,function(err,data){err?errorHandler(err):$input.after('<div><input id="attachment-'+filename.replace(/\s|\\|\/|\(|\)/g,"-")+'" type="hidden" value="'+filename+"\" data-wrapwith=\"<a data-type='attachment' data-key='"+filename+"' href='"+link+"' data-input='"+$input.attr("id")+'\'></a>" /><i class="fa fa-paperclip"></i> '+filename+'<button class="button-xsmall pure-button remove-upload" data-key="'+filename+'"><i class="fa fa-times"></i></button></div>')})}}),$(document).on("click",".pure-button",function(){$(this).blur()}),$(document).bind("keydown",function(event){event.ctrlKey&&83===event.which&&$("#entry-form").is(":visible")&&save(event)}),$("body").on("submit","#application-login",function(e){e.preventDefault(),AWSCognito.config.region=AWS_REGION,AWSCognito.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:ID_POOL_ID}),AWSCognito.config.update({accessKeyId:"test",secretAccessKey:"test"}),$("#application-login *").attr("disabled","disabled");var userPool=new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool({UserPoolId:POOL_ID,ClientId:CLIENT_ID}),authenticationData={Username:$('#application-login input[name="user"]').val(),Password:$('#application-login input[name="pw"]').val()},authenticationDetails=new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData),userData={Username:$('#application-login input[name="user"]').val(),Pool:userPool},cognitoUser=new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);cognitoUser.authenticateUser(authenticationDetails,{onSuccess:function(result){sessionStorage.setItem("cognito-token",result.getIdToken().getJwtToken());var creds={};creds["cognito-idp."+AWS_REGION+".amazonaws.com/"+POOL_ID]=sessionStorage.getItem("cognito-token"),AWS.config.update({credentials:new AWS.CognitoIdentityCredentials({IdentityPoolId:ID_POOL_ID,Logins:creds})}),$.unblockUI()},onFailure:function(err){alert(err),$("#application-login *").removeAttr("disabled")}})})}if(!sessionStorage.getItem("cognito-token")){var h=window.location.href.replace("index.html","");window.location.replace(h+"login.html")}var markedOptions={renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!1,highlight:function(code){return hljs.highlightAuto(code).value}};return 0===SITES.length?void alert("Please configure at least one site in Drafty"):(_.each(SITES,function(item){$("#site-selector ul").append('<li><a href="#" data-site_bucket="'+item.site_bucket+'">'+item.name+"</a></li>")}),$(".dropdown-toggle").click(function(){$(this).next("ul").fadeToggle(250)}),$("#site-selector a").click(function(e){e.preventDefault();var site=_.findWhere(SITES,{site_bucket:$(this).data("site_bucket")});DATA_BUCKET=site.markdown_bucket,ASSETS_BUCKET=site.assets_bucket,SITE_BUCKET=site.site_bucket,AWS_REGION=site.aws_region,SITE_ENDPOINT="http://"+SITE_BUCKET+".s3-website-"+AWS_REGION+".amazonaws.com/",DATATYPES=[],_.each(DEFAULT_DATATYPES,function(dt){DATATYPES.push(dt)}),site.datatypes&&_.each(site.datatypes,function(dt){DATATYPES.push(dt)}),_.each(DATATYPES,function(element){$.get(PARTIALS_PATH+element.id+".html",function(data){element.partial=data,Handlebars.registerPartial("data-type-is-"+element.id,element.partial)})}),TEMPLATES=[],_.each(DEFAULT_TEMPLATES,function(dt){TEMPLATES.push(dt)}),site.templates&&_.each(site.templates,function(dt){TEMPLATES.push(dt)}),initialize(),$("#site-selector ul").fadeOut(250),$("#main").empty().data("key",null)}),void setEvents())}),Handlebars.registerHelper("before_after_split",function(id,wysiwyg){var $context=$.parseHTML(this.content),el=_.findWhere($context,{id:id});return $(el).find(".before, .after").remove(),"wysiwyg"!==wysiwyg?$(el).text():$(el).html()}),Handlebars.registerHelper("radio",function(id,value){var $context=$.parseHTML(this.content),el=_.findWhere($context,{id:id}),html='id="'+id+'" name="'+id+'" value="'+value+'" type="radio"';return $(el).text()==value&&(html+=" checked"),html}),Handlebars.registerHelper("checked_element",function(id){var $context=$.parseHTML(this.content),el=_.findWhere($context,{id:id});if(el)return" checked"}),Handlebars.registerHelper("multiples_text",function(id){var $context=$.parseHTML(this.content),els=_.filter($context,function(element){return 0===element.id.indexOf(id)}),html="";return 0==els.length?html='<div><input type="text" value="" id="'+id+'_0"/></div>':$(els).each(function(){$(this).find(".before, .after").remove(),html+='<div><input type="text" value="'+$(this).text()+'" id="'+$(this).attr("id")+'"/>',$(this).attr("id")!=id+"_0"&&(html+='<button class="button-xsmall pure-button remove-multiple"><i class="fa fa-times"></i></button>'),html+="</div>"}),html+='<button class="button-small pure-button add-multiple" data-target="'+id+'"><i class="fa fa-plus"></i> Add another</button>'});